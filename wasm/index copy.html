<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8"/>
		<script src="wasm_exec.js"></script>
		<script>
      console.log("instantiating go")
			const go = new Go();
      console.log("importing go wasm")
			WebAssembly.instantiateStreaming(fetch("weshnet.wasm"), go.importObject).then((result) => {
        console.log("result", result)
				go.run(result.instance)
        console.log("instance running")

        weshnet_initService()

        const conf = weshnet_serviceGetConfiguration()
        console.log("weshnet conf:", conf)

        weshnet_groupMetadataList(conf.AccountGroupPK, (res) => {
          console.log("recv account metadata:", res)
        })
        weshnet_groupMessageList(conf.AccountGroupPK, (res) => {
          console.log("recv account message:", res)
        })

        const refRes = weshnet_contactRequestReference()
        console.log("base64-url PublicRendezvousSeed:", refRes)

        const mmGroupPK = weshnet_multiMemberGroupCreate()
        weshnet_groupMetadataList(mmGroupPK, (res) => {
          console.log("recv multiMember metadata:", res)
        })
        weshnet_groupMessageList(mmGroupPK, (res) => {
          console.log("recv multiMember message:", res)
        })
        const mmInvit = weshnet_multiMemberGroupInvitationCreate(mmGroupPK)
        console.log("multiMember group invit:", mmInvit)

        setInterval(() => {
          const peers = weshnet_peerList()
          console.log("peers", peers)
        }, 5000)
			});

      function joinGroup() {
        const input = document.getElementById("mmGroupPK")
        const groupPK = weshnet_multiMemberGroupJoin(input.value)
        weshnet_activateGroup(groupPK)
        weshnet_groupMetadataList(groupPK, (res) => {
          console.log("recv external multiMember metadata:", res)
        })
        weshnet_groupMessageList(groupPK, (res) => {
          console.log("recv external multiMember message:", res)
        })
      }
		</script>
	</head>
	<body>
    <input type="text" id="mmGroupPK" />
    <button type="button" onclick="joinGroup()">Join</button>
  </body>
</html>
